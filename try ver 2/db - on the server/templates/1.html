<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Account</title>
    <style>
      body {
        background: linear-gradient(45deg, #000000, #494949);
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        transition: background 0.5s ease, color 0.5s ease;
      }

      .container {
        display: flex;
        max-width: 92%;
        width: 85%;
        box-sizing: border-box;
      }

      .form-container,
      .list-container,
      .log-container {
        border-radius: 5px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        flex: 0.8;
        padding: 30px;
        box-sizing: border-box;
        margin-right: 20px;
      }

      .form-container,
      .list-container,
      .log-container {
        background-color: rgba(31, 31, 31, 0.8);
      }

      .light-theme .form-container,
      .light-theme .list-container,
      .light-theme .log-container {
        background-color: #f5f5f5;
      }

      .search-container {
        /* New class for search box container */
        border-radius: 5px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        padding: 30px;
        flex: 0.5;
        box-sizing: border-box;
        margin-right: 20px;
        /* Added margin to separate from the list form box */
      }

      .search-container {
        /* Styles for the new search box container */
        background-color: rgba(31, 31, 31, 0.8);
      }

      .light-theme .search-container {
        /* Light theme for the search box container */
        background-color: #f5f5f5;
      }

      .form-group {
        margin-bottom: 1.5rem;
        text-align: left;
        transition: color 0.5s ease;
      }

      .light-theme .form-group {
        color: #333333;
      }

      .form-control,
      .log-control {
        background-color: #333333;
        border: none;
        color: #ffffff;
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        border-radius: 5px;
        transition: background-color 0.3s ease, box-shadow 0.3s ease,
          color 0.5s ease;
        box-sizing: border-box;
        outline: none;
        resize: none; /* Prevent textarea from being resized */
        overflow-y: auto; /* Enable vertical scrollbar if content overflows */
      }

      .light-theme .form-control,
      .light-theme .log-control {
        background-color: #e0dfdf;
        color: #333333;
      }

      .form-control:hover,
      .form-control:focus,
      .log-control:hover,
      .log-control:focus {
        background-color: #444444;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      }

      .btn-dark {
        background-color: #666666;
        border: none;
        color: #ffffff;
        font-size: 0.8rem;
        padding: 0.5rem;
        border-radius: 5px;
        transition: background-color 0.3s ease;
        cursor: pointer;
        margin-left: 5px; /* Added margin between buttons */
      }

      .btn-dark:hover {
        background-color: #555555;
      }

      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: #ffffff;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .light-theme {
        background: linear-gradient(45deg, #747577, #ffffff);
        color: #333333;
      }

      #themeSwitch {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background-color: #444444;
        border: none;
        color: #ffffff;
        font-size: 1rem;
        padding: 0.5rem;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      #themeSwitch:hover {
        background-color: #808080;
      }

      /* Style for small and square action buttons */
      .list-item-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .list-item-container button {
        background-color: #666666;
        border: none;
        color: #ffffff;
        font-size: 0.8rem;
        padding: 0.5rem;
        width: 40px;
        height: 40px;
        border-radius: 5px;
        cursor: pointer;
      }

      .list-item-container button:hover {
        background-color: #555555;
      }

      .list-container {
        max-height: 411px; /* Set a maximum height for the list container */
        overflow-y: auto; /* Make the list container scrollable */
        border-radius: 5px; /* Match the roundness of the list container */
        flex: 4;
      }

      /* Style to hide scrollbar */
      .list-container::-webkit-scrollbar {
        width: 0.5em;
        border-radius: 5px; /* Match the roundness of the list container */
      }

      .list-container::-webkit-scrollbar-thumb {
        background-color: #666666;
        border-radius: 5px; /* Match the roundness of the list container */
      }

      /* Hide scrollbar for other browsers */
      .list-container {
        scrollbar-width: thin;
        scrollbar-color: #666666 transparent;
      }
      @media (max-width: 2000px) {
        .container {
          flex-direction: column-reverse;
          align-items: stretch;
          overflow-y: auto; /* Enable vertical scrolling for the container */
        }

        .form-container,
        .list-container,
        .search-container,
        .log-container {
          width: 100%;
          margin-right: 0;
          margin-bottom: 20px;
        }

        .log-container {
          overflow-y: auto; /* Make the log container scrollable if needed */
          flex: 1; /* Allow the log container to take up remaining space */
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="form-container">
        <form id="signupForm" method="post" action="/add_profile">
          <div class="form-group">
            <input
              type="text"
              class="form-control"
              name="name"
              placeholder="Your Name"
            />
          </div>
          <div class="form-group">
            <input
              type="password"
              class="form-control"
              name="password"
              placeholder="Your Password"
            />
          </div>
          <div class="form-group">
            <input
              type="email"
              class="form-control"
              name="email"
              placeholder="Your Email"
            />
          </div>
          <div class="form-group">
            <input
              type="number"
              class="form-control"
              name="time"
              placeholder="Time (minutes)"
              min="0"
            />
          </div>
          <div class="form-group">
            <button type="submit" class="btn-dark" onclick="showPopup()">
              Create Account
            </button>
          </div>
        </form>
      </div>
      <div class="list-container" id="dynamicList">
        <!-- List content will be added dynamically with JavaScript -->
        <!-- Add more items as needed -->
      </div>
      <div class="search-container">
        <input
          type="text"
          id="searchBox"
          class="form-control"
          placeholder="Search..."
          oninput="filterList()"
        />

        <label>
          <input type="checkbox" id="filterName" onclick="filterList()" />
          Name
        </label>
        <label>
          <input type="checkbox" id="filterPassword" onclick="filterList()" />
          Password
        </label>
        <label>
          <input type="checkbox" id="filterEmail" onclick="filterList()" />
          Email
        </label>
        <label>
          <input type="checkbox" id="filterTime" onclick="filterList()" />
          Time
        </label>
      </div>
      <div class="log-container">
        <h2>Logs</h2>
        <textarea
          class="log-control"
          id="logTextarea"
          rows="10"
          readonly
        ></textarea>
      </div>
    </div>
    <div id="responsePopup" class="popup">{{ response_message }}</div>
    <button id="themeSwitch" onclick="toggleTheme()">Toggle Theme</button>
    <script>
      function showPopup() {
        var responsePopup = document.getElementById("responsePopup");
        responsePopup.style.display = "block";
        setTimeout(function () {
          responsePopup.style.display = "none";
        }, 3000);
      }

      function toggleTheme() {
        document.body.classList.toggle("light-theme");
      }

      function loadLogs() {
        var logTextarea = document.getElementById("logTextarea");
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4) {
            if (xhr.status == 200) {
              logTextarea.value = xhr.responseText;
            } else {
              console.error("Failed to load logs. Status: " + xhr.status);
            }
          }
        };
        xhr.open("GET", "/logs", true);
        xhr.send();
      }

      function createButtonsForList() {
        var listContainer = document.getElementById("dynamicList");

        // Fetch data from the server
        fetch("/get_all_profiles")
          .then((response) => response.json())
          .then((data) => {
            data.forEach((item, index) => {
              try {
                // Create container for each item
                var lineContainer = document.createElement("div");
                lineContainer.className = "list-item-container";

                // Create divs for different properties of the item
                var nameDiv = createDiv("Name", item[1]);
                var passwordDiv = createDiv("Password", item[2]);
                var emailDiv = createDiv("Email", item[3]);
                var dateDiv = createDiv("Date", formatDate(item[4]));
                var timeDiv = createDiv("Time", formatTime(item[4]));

                // Create buttons container
                var buttonsContainer = document.createElement("div");
                buttonsContainer.style.display = "flex";

                // Create "T" button
                var button1 = createButton("T", item[0]);
                buttonsContainer.appendChild(button1);

                // Create "X" button with item ID
                var button2 = createButton("X", item[0]);
                buttonsContainer.appendChild(button2);

                // Append divs and buttons to the line container
                lineContainer.appendChild(nameDiv);
                lineContainer.appendChild(passwordDiv);
                lineContainer.appendChild(emailDiv);
                lineContainer.appendChild(dateDiv);
                lineContainer.appendChild(timeDiv);
                lineContainer.appendChild(buttonsContainer);

                // Append line container to the list container
                listContainer.appendChild(lineContainer);
              } catch (error) {
                console.error(
                  `Error processing item at index ${index}:`,
                  error
                );
              }
            });
          })
          .catch((error) => console.error("Error fetching data:", error));
      }

      // Function to create a div with a specified label and content
      function createDiv(label, content) {
        var div = document.createElement("div");
        div.innerHTML = `<strong>${label}:</strong> ${content || ""}`;
        return div;
      }

      // Function to create a button with a specified text and data attribute
      function createButton(text, data) {
        var button = document.createElement("button");
        button.className = "btn-dark";
        button.innerHTML = text;
        button.setAttribute("data-id", data || ""); // Set data attribute with item ID
        return button;
      }

      // Function to format date (assuming the input is in milliseconds)
      function formatDate(milliseconds) {
        return new Date(milliseconds).toLocaleDateString("en-US");
      }

      // Function to format time (assuming the input is in milliseconds)
      function formatTime(milliseconds) {
        return new Date(milliseconds).toLocaleTimeString("en-US", {
          hour12: false,
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Delegate the click event to the document, filtering for the "X" button clicks
        document.addEventListener("click", function (event) {
          var target = event.target;

          // Check if the clicked button has the class "btn-dark" and contains "X" text
          if (
            target.classList.contains("btn-dark") &&
            target.innerHTML === "X"
          ) {
            console.log("X button clicked!");

            // Retrieve the ID associated with the item
            var itemId = target.getAttribute("data-id");
            if (!itemId) {
              console.error("Unable to find ID attribute.");
              return;
            }

            console.log("Deleting item with ID:", itemId);

            // Send a DELETE request to remove the item
            fetch(`/remove_profile/${itemId}`, { method: "DELETE" })
              .then((response) => {
                if (response.ok) {
                  console.log(`Item with ID ${itemId} deleted successfully.`);
                  // You may also want to remove the item from the UI
                  target.closest(".list-item-container").remove();
                } else {
                  console.error(`Failed to delete item with ID ${itemId}.`);
                }
              })
              .catch((error) => console.error("Error:", error));
          }
        });
      });

      document.addEventListener("click", function (event) {
        var target = event.target;

        // Check if the clicked button has the class "btn-dark" and contains "T" text
        if (target.classList.contains("btn-dark") && target.innerHTML === "T") {
          console.log("T button clicked!");

          // Extract the profile ID from the data attribute
          var profileId = target.getAttribute("data-id");
          if (profileId) {
            // Prompt the user for the number of minutes
            var minutesToAdd = prompt("Enter the number of minutes:");

            // Check if the user entered a valid number
            if (minutesToAdd !== null && !isNaN(minutesToAdd)) {
              // Send a POST request to add time
              fetch("/add_time", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  profile_id: profileId,
                  minutes_to_add: parseInt(minutesToAdd),
                }),
              })
                .then((response) => {
                  if (response.ok) {
                    return response.json();
                  } else {
                    throw new Error("Failed to add time.");
                  }
                })
                .then((data) => {
                  console.log("New time:", data.new_time);
                  // You can update the UI or do other things with the new time
                })
                .catch((error) => console.error("Error:", error));
            } else {
              console.log("Invalid input or user cancelled.");
            }
          } else {
            console.error("Profile ID not found.");
          }
        }
      });

      function filterList() {
        var searchBox = document.getElementById("searchBox");
        var filterName = document.getElementById("filterName").checked;
        var filterPassword = document.getElementById("filterPassword").checked;
        var filterEmail = document.getElementById("filterEmail").checked;
        var filterTime = document.getElementById("filterTime").checked;

        var listContainer = document.getElementById("dynamicList");
        var items = listContainer.getElementsByClassName("list-item-container");

        var query = searchBox.value.toLowerCase();

        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          var text = item.textContent || item.innerText;

          var shouldDisplay = false;

          if (
            (filterName &&
              text.toLowerCase().includes("name:") &&
              text.toLowerCase().includes(query)) ||
            (filterPassword &&
              text.toLowerCase().includes("password:") &&
              text.toLowerCase().includes(query)) ||
            (filterEmail &&
              text.toLowerCase().includes("email:") &&
              text.toLowerCase().includes(query)) ||
            (filterTime &&
              text.toLowerCase().includes("time:") &&
              text.toLowerCase().includes(query)) ||
            (!filterName &&
              !filterPassword &&
              !filterEmail &&
              !filterTime &&
              text.toLowerCase().includes(query))
          ) {
            shouldDisplay = true;
          }

          item.style.display = shouldDisplay ? "" : "none";
        }
      }

      // Trigger the function to create buttons
      loadLogs();
      createButtonsForList();
    </script>
  </body>
</html>
